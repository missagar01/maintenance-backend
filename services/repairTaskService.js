import repairPool from "../config/repairdb.js";

export const insertRepairTask = async (data) => {
  const query = `
    INSERT INTO repair_system (
      time_stamp,
      task_no,
      serial_no,
      machine_name,
      machine_part_name,
      given_by,
      doer_name,
      problem_with_machine,
      enable_reminders,
      require_attachment,
      task_start_date,
      task_ending_date,
      priority,
      department,
      location,
      image_link
    )
    VALUES (
      $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16
    )
    RETURNING *;
  `;

  // Format dates from frontend (DD/MM/YYYY HH:MM:SS) to PostgreSQL format
  let formattedStartDate = null;
  let formattedEndDate = null;

  if (data.task_start_date) {
    const dateTimeParts = data.task_start_date.split(' ');
    if (dateTimeParts.length >= 2) {
      const datePart = dateTimeParts[0]; // DD/MM/YYYY
      const timePart = dateTimeParts[1]; // HH:MM:SS
      const [day, month, year] = datePart.split('/');
      formattedStartDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')} ${timePart}`;
    }
  }

  if (data.task_ending_date) {
    const dateTimeParts = data.task_ending_date.split(' ');
    if (dateTimeParts.length >= 2) {
      const datePart = dateTimeParts[0]; // DD/MM/YYYY
      const timePart = dateTimeParts[1]; // HH:MM:SS
      const [day, month, year] = datePart.split('/');
      formattedEndDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')} ${timePart}`;
    }
  }

  const values = [
    data.time_stamp || new Date().toISOString(),
    data.task_no || null, // Will be auto-generated by trigger
    data.serial_no || '',
    data.machine_name || '',
    data.machine_part_name || '',
    data.given_by || '',
    data.doer_name || '',
    data.problem_with_machine || '',
    data.enable_reminders === "Yes" || data.enable_reminders === true,
    data.require_attachment === "Yes" || data.require_attachment === true,
    formattedStartDate,
    formattedEndDate,
    data.priority || 'Medium',
    data.department || '',
    data.location || '',
    data.image_link || ''
  ];

  try {
    const result = await repairPool.query(query, values);
    return result.rows[0];
  } catch (err) {
    console.error("❌ Repair DB insert error:", err.message);
    throw err;
  }
};

export const getNextRepairTaskNumber = async () => {
  try {
    const query = `SELECT task_no FROM repair_system ORDER BY id DESC LIMIT 1;`;
    const result = await repairPool.query(query);

    if (result.rows.length === 0) return "TR-001";

    const lastTask = result.rows[0].task_no || "TR-000";
    const lastNum = parseInt(lastTask.replace("TR-", "")) || 0;
    const nextNum = lastNum + 1;
    return `TR-${String(nextNum).padStart(3, "0")}`;
  } catch (err) {
    console.error("❌ Error getting next repair task number:", err.message);
    return "TR-001"; // Fallback
  }
};

export const getAllRepairTasks = async () => {
  try {
    const query = `
      SELECT 
        id,
        task_no,
        serial_no,
        machine_name,
        machine_part_name,
        given_by,
        doer_name,
        problem_with_machine,
        enable_reminders,
        require_attachment,
        task_start_date,
        task_ending_date,
        priority,
        department,
        location,
        image_link,
        status,
        created_at
      FROM repair_system
      ORDER BY id DESC;
    `;
    const result = await repairPool.query(query);
    return result.rows;
  } catch (err) {
    console.error("❌ Error fetching repair tasks:", err.message);
    throw err;
  }
};